#!/usr/bin/perl

use Nagios::Plugin;
use ElasticSearch;
use Data::Dumper;

use strict;

my $np = Nagios::Plugin->new(
		usage=> "Usage: %s [ -v|--verbose ] [ -H <host>] [-t <timeout>]"
		);

		
$np->add_arg( spec=>'host|h=s',
	help=> '-h, --host <host>');		
$np->getopts;

my $host= $np->opts->host;

my $e;
my $cluster_status;
my $index_status;
my $node_stats;
eval
{
  $e= ElasticSearch->new(
		servers=> "$host".':9200',
		transport=>'httplite'
		);


  $cluster_status= $e->cluster_health;
  $index_status= $e->index_status(index=>'current');
  $node_stats = $e->nodes_stats;
};
$np->nagios_exit( CRITICAL, "unable to check elastic search: $@") if $@;

my $index = (keys( %{$index_status->{'indices'}}))[0];



$np->add_perfdata(label=> "size",
		  value=> $index_status->{indices}->{$index}->{store_size_in_bytes},
		  uom => 'B'
		  );

$np->add_perfdata(label=> "count",
		  value=> $index_status->{indices}->{$index}->{docs}->{num_docs},
		  );
		  
$np->nagios_exit( CRITICAL, "cluster status RED") if $cluster_status->{status} eq 'red';
$np->nagios_exit( WARNING, "cluster status yellow") if $cluster_status->{status} eq 'yellow';
$np->nagios_exit( WARNING, "unassigned shards: ". $cluster_status->{unassigned_shards}) if $cluster_status->{unassigned_shards};

$np->nagios_exit( CRITICAL, "not OK") unless $index_status->{ok};

#print Dumper($cluster_status);
#$Data::Dumper::Maxdepth= 4;
#print Dumper($node_stats);		
#print $index."\n";
$np->nagios_exit(OK,"no problems found");
