#!/bin/bash

# Install Claude Code CLI tool via curl
# This script runs once when chezmoi is applied

echo "üì¶ Installing Claude Code CLI..."

# Check if Claude Code is already installed and working
if command -v claude >/dev/null 2>&1; then
  CURRENT_VERSION=$(claude --version 2>/dev/null | grep -o '[0-9.]*' | head -1)
  if [ -n "$CURRENT_VERSION" ]; then
    echo "‚úÖ Claude Code already installed (version $CURRENT_VERSION)"
    
    # Check if it was installed via npm and uninstall if so
    if npm list -g @anthropic-ai/claude-code >/dev/null 2>&1; then
      echo "üîÑ Uninstalling npm version first..."
      npm uninstall -g @anthropic-ai/claude-code >/dev/null 2>&1
      echo "üì¶ Proceeding with curl installation..."
    else
      exit 0
    fi
  fi
fi

# Ensure curl is available
if ! command -v curl >/dev/null 2>&1; then
  echo "‚ùå curl not found. Please install curl first"
  exit 1
fi

# Install Claude Code via curl
echo "Installing Claude Code via curl..."
if curl -fsSL http://claude.ai/install.sh | bash; then
  echo "‚úÖ Claude Code installed successfully"
  
  # Verify installation
  if claude --version >/dev/null 2>&1; then
    echo "‚úÖ Claude Code verified working"
  else
    echo "‚ö†Ô∏è  Claude Code installed but may need PATH refresh"
  fi
else
  echo "‚ùå Failed to install Claude Code"
  exit 1
fi